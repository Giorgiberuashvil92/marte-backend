# ­Ъћё рЃарЃЮрЃњрЃЮрЃа рЃЊрЃљрЃЋрЃбрЃћрЃАрЃбрЃЮ Recurring Payments рЃарЃћрЃљрЃџрЃБрЃарЃў рЃњрЃљрЃЊрЃљрЃ«рЃЊрЃўрЃЌ

## ­ЪЊІ рЃюрЃљрЃЉрЃўрЃ»рЃћрЃЉрЃў:

### 1. рЃърЃўрЃарЃЋрЃћрЃџрЃў рЃарЃћрЃљрЃџрЃБрЃарЃў рЃњрЃљрЃЊрЃљрЃ«рЃЊрЃљ

1. **рЃњрЃљрЃЊрЃљрЃ«рЃЊрЃўрЃА рЃњрЃљрЃюрЃ«рЃЮрЃарЃфрЃўрЃћрЃџрЃћрЃЉрЃљ** BOG-рЃўрЃЌ (frontend-рЃўрЃЊрЃљрЃю рЃљрЃю API-рЃЊрЃљрЃю)
2. **рЃњрЃљрЃЊрЃљрЃ«рЃЊрЃўрЃА рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃўрЃА рЃерЃћрЃЏрЃЊрЃћрЃњ**, BOG callback-рЃў рЃњрЃљрЃЏрЃЮрЃўрЃФрЃљрЃ«рЃћрЃЉрЃА `POST /bog/callback`
3. **Callback handler** рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ рЃерЃћрЃўрЃюрЃљрЃ«рЃљрЃЋрЃА `order_id` рЃарЃЮрЃњрЃЮрЃарЃф `paymentToken`

### 2. Payment Token-рЃўрЃА рЃерЃћрЃюрЃљрЃ«рЃЋрЃљ Subscription-рЃерЃў

рЃарЃЮрЃфрЃљ рЃњрЃљрЃЊрЃљрЃ«рЃЊрЃљ рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃБрЃџрЃўрЃљ, рЃБрЃюрЃЊрЃљ рЃерЃћрЃЋрЃўрЃюрЃљрЃ«рЃЮрЃЌ `order_id` subscription-рЃўрЃА `bogCardToken`-рЃерЃў:

#### рЃЋрЃљрЃарЃўрЃљрЃюрЃбрЃў A: MongoDB-рЃерЃў рЃърЃўрЃарЃЊрЃљрЃърЃўрЃа

```javascript
// MongoDB Compass рЃљрЃю mongo shell-рЃерЃў
db.subscriptions.updateOne(
  { userId: "рЃЌрЃЦрЃЋрЃћрЃюрЃў_user_id" },
  { 
    $set: { 
      bogCardToken: "рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃБрЃџрЃў_рЃњрЃљрЃЊрЃљрЃ«рЃЊрЃўрЃА_order_id",
      status: "active",
      nextBillingDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000) // 30 рЃЊрЃдрЃўрЃА рЃерЃћрЃЏрЃЊрЃћрЃњ
    } 
  }
);
```

#### рЃЋрЃљрЃарЃўрЃљрЃюрЃбрЃў B: API Endpoint-рЃўрЃА рЃњрЃљрЃЏрЃЮрЃДрЃћрЃюрЃћрЃЉрЃљ

```bash
# 1. рЃЏрЃўрЃўрЃдрЃћ payment token user-рЃўрЃАрЃЌрЃЋрЃўрЃА
curl http://localhost:3000/api/payments/user/{userId}/token

# Response:
{
  "success": true,
  "data": {
    "paymentToken": "real_bog_order_id_12345"
  }
}

# 2. рЃерЃћрЃўрЃюрЃљрЃ«рЃћ subscription-рЃерЃў (MongoDB-рЃерЃў рЃљрЃю рЃерЃћрЃЦрЃЏрЃћрЃюрЃў subscription endpoint)
```

### 3. Subscription-рЃўрЃА рЃерЃћрЃЦрЃЏрЃюрЃљ/рЃњрЃљрЃюрЃљрЃ«рЃџрЃћрЃЉрЃљ

```javascript
// MongoDB-рЃерЃў
db.subscriptions.insertOne({
  userId: "рЃЌрЃЦрЃЋрЃћрЃюрЃў_user_id",
  planId: "premium_monthly",
  planName: "Premium Plan",
  planPrice: 50.00,
  currency: "GEL",
  period: "monthly",
  status: "active",
  startDate: new Date(),
  nextBillingDate: new Date(Date.now() - 3600000), // 1 рЃАрЃљрЃљрЃЌрЃўрЃА рЃгрЃўрЃю (рЃбрЃћрЃАрЃбрЃўрЃарЃћрЃЉрЃўрЃАрЃЌрЃЋрЃўрЃА)
  paymentMethod: "BOG",
  bogCardToken: "рЃарЃћрЃљрЃџрЃБрЃарЃў_BOG_order_id_рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃБрЃџрЃў_рЃњрЃљрЃЊрЃљрЃ«рЃЊрЃўрЃАрЃњрЃљрЃю", // Рџа№ИЈ рЃћрЃА рЃБрЃюрЃЊрЃљ рЃўрЃДрЃЮрЃА рЃарЃћрЃљрЃџрЃБрЃарЃў!
  billingCycles: 0,
  totalPaid: 0,
  createdAt: new Date(),
  updatedAt: new Date()
});
```

### 4. Recurring Payment-рЃўрЃА рЃбрЃћрЃАрЃбрЃўрЃарЃћрЃЉрЃљ

#### A. Manual Trigger:

```bash
curl -X POST http://localhost:3000/api/recurring-payments/process
```

**Response:**
```json
{
  "success": true,
  "message": "рЃарЃћрЃЎрЃБрЃарЃўрЃюрЃњ рЃњрЃљрЃЊрЃљрЃ«рЃЊрЃћрЃЉрЃў рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃўрЃЌ рЃЊрЃљрЃЏрЃБрЃерЃљрЃЋрЃЊрЃљ",
  "data": {
    "success": 1,
    "failed": 0,
    "total": 1
  }
}
```

#### B. BOG Recurring Payment рЃърЃўрЃарЃЊрЃљрЃърЃўрЃа:

```bash
curl -X POST http://localhost:3000/bog/recurring-payment \
  -H "Content-Type: application/json" \
  -d '{
    "order_id": "рЃарЃћрЃљрЃџрЃБрЃарЃў_BOG_order_id",
    "amount": 50.00,
    "currency": "GEL",
    "shop_order_id": "recurring_test_123",
    "purchase_description": "Monthly subscription"
  }'
```

### 5. рЃерЃћрЃЊрЃћрЃњрЃћрЃЉрЃўрЃА рЃерЃћрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃљ

#### A. Subscription-рЃўрЃА рЃерЃћрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃљ:

```javascript
db.subscriptions.findOne({ userId: "рЃЌрЃЦрЃЋрЃћрЃюрЃў_user_id" })
```

рЃерЃћрЃљрЃЏрЃЮрЃгрЃЏрЃћ:
- РюЁ `billingCycles` рЃњрЃљрЃўрЃќрЃљрЃарЃЊрЃљ
- РюЁ `totalPaid` рЃњрЃљрЃўрЃќрЃљрЃарЃЊрЃљ
- РюЁ `nextBillingDate` рЃњрЃљрЃюрЃљрЃ«рЃџрЃЊрЃљ (рЃЏрЃЮрЃЏрЃЊрЃћрЃЋрЃюрЃЮ рЃЌрЃЋрЃћ)
- РюЁ `status` = `active`

#### B. Payment-рЃћрЃЉрЃўрЃА рЃерЃћрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃљ:

```javascript
db.payments.find({ 
  userId: "рЃЌрЃЦрЃЋрЃћрЃюрЃў_user_id",
  context: "subscription"
}).sort({ paymentDate: -1 })
```

рЃБрЃюрЃЊрЃљ рЃ«рЃћрЃЊрЃљрЃЋрЃЊрЃћ:
- РюЁ рЃљрЃ«рЃљрЃџрЃў payment `status: "completed"`
- РюЁ `amount` = subscription planPrice
- РюЁ `orderId` = рЃљрЃ«рЃљрЃџрЃў BOG order_id

#### C. Backend Logs:

рЃБрЃюрЃЊрЃљ рЃ«рЃћрЃЊрЃљрЃЋрЃЊрЃћ:
```
­Ъћё рЃарЃћрЃЎрЃБрЃарЃўрЃюрЃњ рЃњрЃљрЃЊрЃљрЃ«рЃЊрЃћрЃЉрЃўрЃА рЃЊрЃљрЃЏрЃБрЃерЃљрЃЋрЃћрЃЉрЃљ рЃЊрЃљрЃгрЃДрЃћрЃЉрЃБрЃџрЃўрЃљ...
­ЪЊі рЃюрЃљрЃърЃЮрЃЋрЃюрЃўрЃљ 1 subscription рЃарЃћрЃЎрЃБрЃарЃўрЃюрЃњ рЃњрЃљрЃЊрЃљрЃ«рЃЊрЃўрЃАрЃЌрЃЋрЃўрЃА
­Ъњ│ Subscription ... рЃњрЃљрЃЊрЃљрЃ«рЃЊрЃўрЃА рЃЊрЃљрЃЏрЃБрЃерЃљрЃЋрЃћрЃЉрЃљ...
РюЁ рЃарЃћрЃЎрЃБрЃарЃўрЃюрЃњ рЃњрЃљрЃЊрЃљрЃ«рЃЊрЃљ рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃўрЃЌ рЃњрЃљрЃюрЃ«рЃЮрЃарЃфрЃўрЃћрЃџрЃЊрЃљ
РюЁ Subscription ... рЃњрЃљрЃЊрЃљрЃ«рЃЊрЃљ рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃўрЃЌ рЃњрЃљрЃюрЃ«рЃЮрЃарЃфрЃўрЃћрЃџрЃЊрЃљ
```

---

## ­Ъј» рЃАрЃгрЃарЃљрЃцрЃў рЃбрЃћрЃАрЃбрЃў:

1. **рЃњрЃљрЃљрЃЎрЃћрЃЌрЃћ рЃарЃћрЃљрЃџрЃБрЃарЃў рЃњрЃљрЃЊрЃљрЃ«рЃЊрЃљ** BOG-рЃўрЃЌ
2. **рЃЏрЃўрЃўрЃдрЃћ `order_id`** рЃњрЃљрЃЊрЃљрЃ«рЃЊрЃўрЃА рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃўрЃА рЃерЃћрЃЏрЃЊрЃћрЃњ
3. **рЃерЃћрЃўрЃюрЃљрЃ«рЃћ subscription-рЃерЃў:**
   ```javascript
   db.subscriptions.updateOne(
     { userId: "рЃЌрЃЦрЃЋрЃћрЃюрЃў_user_id" },
     { $set: { bogCardToken: "рЃарЃћрЃљрЃџрЃБрЃарЃў_order_id" } }
   );
   ```
4. **рЃЊрЃљрЃљрЃДрЃћрЃюрЃћ `nextBillingDate` рЃгрЃљрЃарЃАрЃБрЃџрЃерЃў** (рЃбрЃћрЃАрЃбрЃўрЃарЃћрЃЉрЃўрЃАрЃЌрЃЋрЃўрЃА):
   ```javascript
   db.subscriptions.updateOne(
     { userId: "рЃЌрЃЦрЃЋрЃћрЃюрЃў_user_id" },
     { $set: { nextBillingDate: new Date(Date.now() - 3600000) } }
   );
   ```
5. **рЃњрЃљрЃБрЃерЃЋрЃў manual trigger:**
   ```bash
   curl -X POST http://localhost:3000/api/recurring-payments/process
   ```

---

## Рџа№ИЈ рЃЏрЃюрЃўрЃерЃЋрЃюрЃћрЃџрЃЮрЃЋрЃљрЃюрЃў:

1. **BOG Recurring Payments** рЃЏрЃ«рЃЮрЃџрЃЮрЃЊ production-рЃерЃў рЃўрЃЏрЃБрЃерЃљрЃЋрЃћрЃЉрЃА, рЃЌрЃБ BOG-рЃерЃў рЃњрЃљрЃЦрЃЋрЃА рЃљрЃЦрЃбрЃўрЃЋрЃўрЃарЃћрЃЉрЃБрЃџрЃў
2. **`bogCardToken`** рЃБрЃюрЃЊрЃљ рЃўрЃДрЃЮрЃА **рЃарЃћрЃљрЃџрЃБрЃарЃў рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃБрЃџрЃў рЃњрЃљрЃЊрЃљрЃ«рЃЊрЃўрЃА `order_id`** BOG-рЃЊрЃљрЃю
3. **рЃърЃўрЃарЃЋрЃћрЃџрЃў рЃњрЃљрЃЊрЃљрЃ«рЃЊрЃљ** рЃБрЃюрЃЊрЃљ рЃўрЃДрЃЮрЃА рЃЏрЃўрЃюрЃўрЃЏрЃБрЃЏ 0.10РѓЙ (BOG-рЃўрЃА рЃЏрЃЮрЃЌрЃ«рЃЮрЃЋрЃюрЃљ)
4. **Callback handler** рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ рЃерЃћрЃўрЃюрЃљрЃ«рЃљрЃЋрЃА `paymentToken` рЃњрЃљрЃЊрЃљрЃ«рЃЊрЃўрЃА рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃўрЃА рЃерЃћрЃЏрЃЊрЃћрЃњ

---

## ­ЪЊЮ рЃарЃћрЃљрЃџрЃБрЃарЃў рЃњрЃљрЃЊрЃљрЃ«рЃЊрЃўрЃА рЃЏрЃљрЃњрЃљрЃџрЃўрЃЌрЃў:

```bash
# 1. рЃерЃћрЃЦрЃЏрЃћрЃюрЃў рЃњрЃљрЃЊрЃљрЃ«рЃЊрЃљ
POST /bog/create-order
{
  "total_amount": 0.10,  // рЃЏрЃўрЃюрЃўрЃЏрЃБрЃЏ 0.10РѓЙ
  "currency": "GEL",
  "external_order_id": "test_payment_123",
  "callback_url": "https://your-domain.com/bog/callback"
}

# 2. рЃњрЃљрЃЊрЃљрЃ«рЃЊрЃўрЃА рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃўрЃА рЃерЃћрЃЏрЃЊрЃћрЃњ, callback-рЃерЃў рЃЏрЃўрЃўрЃдрЃћрЃЉ order_id
# 3. рЃћрЃА order_id рЃњрЃљрЃЏрЃЮрЃўрЃДрЃћрЃюрЃћ subscription-рЃўрЃАрЃЌрЃЋрЃўрЃА
```

---

## РюЁ Success Checklist:

- [ ] рЃарЃћрЃљрЃџрЃБрЃарЃў рЃњрЃљрЃЊрЃљрЃ«рЃЊрЃљ рЃњрЃљрЃЎрЃћрЃЌрЃћрЃЉрЃБрЃџрЃўрЃљ BOG-рЃўрЃЌ
- [ ] `order_id` рЃЏрЃўрЃдрЃћрЃЉрЃБрЃџрЃўрЃљ рЃњрЃљрЃЊрЃљрЃ«рЃЊрЃўрЃА рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃўрЃА рЃерЃћрЃЏрЃЊрЃћрЃњ
- [ ] `order_id` рЃерЃћрЃюрЃљрЃ«рЃБрЃџрЃўрЃљ subscription-рЃўрЃА `bogCardToken`-рЃерЃў
- [ ] `nextBillingDate` рЃЊрЃљрЃДрЃћрЃюрЃћрЃЉрЃБрЃџрЃўрЃљ рЃгрЃљрЃарЃАрЃБрЃџрЃерЃў (рЃбрЃћрЃАрЃбрЃўрЃарЃћрЃЉрЃўрЃАрЃЌрЃЋрЃўрЃА)
- [ ] Manual trigger рЃљрЃЉрЃарЃБрЃюрЃћрЃЉрЃА `success: 1`
- [ ] Subscription-рЃўрЃА `billingCycles` рЃњрЃљрЃўрЃќрЃљрЃарЃЊрЃљ
- [ ] рЃљрЃ«рЃљрЃџрЃў payment рЃерЃћрЃўрЃЦрЃЏрЃюрЃљ database-рЃерЃў

